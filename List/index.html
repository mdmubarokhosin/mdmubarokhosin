<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NumberList - Firebase Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        body {
            background-color: white; 
        }

        /* Connection Status Styles */
        .connected {
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }
        .disconnected {
            background-color: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }
        .connecting {
            background-color: #FEF3C7;
            color: #92400E;
            border: 1px solid #FDE68A;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6B7280;
        }
        .no-numbers {
            text-align: center;
            padding: 30px;
            color: #6B7280;
            font-style: italic;
        }
        
        /* Custom Radio Button Styles */
        input[type="radio"].hidden-radio {
            display: none;
        }
        .shift-radio-label {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            background-color: #F9FAFB;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .shift-radio-label:hover {
            background-color: #F3F4F6;
            border-color: #9CA3AF;
        }
        input[type="radio"]:checked + .shift-radio-label {
            background-color: #4F46E5;
            color: white;
            border-color: #4338CA;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input[type="radio"]:focus-visible + .shift-radio-label {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px #C7D2FE;
        }

        /* List item hover effect */
        #numbers-list li:not(.loading):not(.no-numbers) {
            transition: all 0.15s ease-in-out;
        }
        #numbers-list li:not(.loading):not(.no-numbers):hover {
            background-color: #F9FAFB;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.03);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pt-20"> 
    
    <header class="fixed top-0 left-0 right-0 bg-gradient-to-r from-indigo-600 to-purple-600 shadow-lg z-50">
        <h1 class="text-center text-xl md:text-2xl font-bold text-white py-4 flex items-center justify-center gap-2">
            <i class="bi bi-list-ol"></i>
            <span>NumberList</span>
        </h1>
    </header>
    
    <main class="container mx-auto px-4 py-6 max-w-4xl">
        <div class="bg-white rounded-xl shadow-xl p-6 mb-6 border-t-4 border-indigo-500">
            
            <div class="text-center mb-6">
                <div id="connection-status" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm shadow-sm">
                    </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="flex flex-col">
                    <label for="date-picker" class="font-medium mb-2 text-gray-700">Select Date:</label>
                    <input type="date" id="date-picker" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                </div>
                
                <div class="flex flex-col">
                    <label class="font-medium mb-2 text-gray-700">Select Shift:</label>
                    <div class="flex gap-3">
                        <label class="flex-1">
                            <input type="radio" name="shift" value="day" checked class="hidden-radio">
                            <span class="shift-radio-label justify-center">
                                <i class="bi bi-sun-fill"></i> Day
                            </span>
                        </label>
                        <label class="flex-1">
                            <input type="radio" name="shift" value="night" class="hidden-radio">
                            <span class="shift-radio-label justify-center">
                                <i class="bi bi-moon-stars-fill"></i> Night
                            </span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <label for="number-input" class="font-medium mb-2 text-gray-700 block">Add New Number:</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative flex-1">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 pointer-events-none">
                            <i class="bi bi-hash"></i>
                        </span>
                        <input type="text" id="number-input" placeholder="Enter number..." class="w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>
                    <button id="add-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        <i class="bi bi-plus-circle-fill"></i> <span>Add</span>
                    </button>
                </div>
            </div>
            
            <div class="mb-6">
                <label for="search-input" class="font-medium mb-2 text-gray-700 block">Search Numbers:</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 pointer-events-none">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" id="search-input" placeholder="Search saved numbers..." class="w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                </div>
            </div>
            
            <div class="mb-6">
                <label class="font-medium mb-2 text-gray-700 block">Search Scope:</label>
                <div class="flex gap-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" id="search-current" name="search-scope" value="current" checked class="mr-2 h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                        <span class="font-medium text-gray-700">Current List</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" id="search-all" name="search-scope" value="all" class="mr-2 h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                        <span class="font-medium text-gray-700">All History</span>
                    </label>
                </div>
            </div>
            
            <hr class="my-6 border-gray-200">
            
            <div>
                <h3 id="list-title" class="text-xl font-semibold text-gray-800 mb-4">Current List</h3>
                <ul id="numbers-list" class="space-y-3">
                    </ul>
            </div>
        </div>
    </main>
    
    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBeCzn6eJeZhpvkQhVNxVV9DOWnInOetp4",
        authDomain: "script-store-360.firebaseapp.com",
        databaseURL: "https://script-store-360-default-rtdb.firebaseio.com",
        projectId: "script-store-360",
        storageBucket: "script-store-360.firebasestorage.app",
        messagingSenderId: "475170411602",
        appId: "1:475170411602:web:a81786ca3dc918742dfb8b",
        measurementId: "G-GG98TLYCRR"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const today = new Date().toISOString().split('T')[0];

    // State variables
    let currentData = {};
    let currentDate = today;
    let currentShift = 'day';
    let isFirebaseConnected = false;
    let currentSearchMode = 'current'; // *** NEW: 'current' or 'all'

    // DOM elements
    const datePicker = document.getElementById('date-picker');
    const dayRadio = document.querySelector('input[name="shift"][value="day"]');
    const nightRadio = document.querySelector('input[name="shift"][value="night"]');
    const numberInput = document.getElementById('number-input');
    const addBtn = document.getElementById('add-btn');
    const searchInput = document.getElementById('search-input');
    const numbersList = document.getElementById('numbers-list');
    const connectionStatus = document.getElementById('connection-status');
    const searchCurrentRadio = document.getElementById('search-current'); // *** NEW
    const searchAllRadio = document.getElementById('search-all'); // *** NEW
    const listTitle = document.getElementById('list-title'); // *** NEW

    // Initialize the app
    function initApp() {
        datePicker.value = today;
        updateConnectionStatus('connecting');
        setupEventListeners();
        loadDataFromFirebase();
    }

    // Update connection status display
    function updateConnectionStatus(status = 'connecting') {
        if (status === 'connected') {
            connectionStatus.innerHTML = '<i class="bi bi-check-circle-fill"></i> <span>Connected</span>';
            connectionStatus.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm shadow-sm connected';
        } else if (status === 'failed') {
            connectionStatus.innerHTML = '<i class="bi bi-x-circle-fill"></i> <span>Connection Failed</span>';
            connectionStatus.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm shadow-sm disconnected';
        } else { 
            connectionStatus.innerHTML = '<i class="bi bi-arrow-repeat animate-spin"></i> <span>Connecting...</span>';
            connectionStatus.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm shadow-sm connecting';
        }
    }

    // Set up event listeners
    function setupEventListeners() {
        datePicker.addEventListener('change', function() {
            currentDate = this.value;
            loadDataForCurrentSelection();
        });
        
        dayRadio.addEventListener('change', function() {
            if (this.checked) {
                currentShift = 'day';
                loadDataForCurrentSelection();
            }
        });
        
        nightRadio.addEventListener('change', function() {
            if (this.checked) {
                currentShift = 'night';
                loadDataForCurrentSelection();
            }
        });
        
        addBtn.addEventListener('click', addNumber);
        
        numberInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addNumber();
        });
        
        numberInput.addEventListener('input', function() {
            this.value = sanitizeInput(this.value);
        });
        
        searchInput.addEventListener('input', filterNumbers);
        
        // *** NEW: Search scope listeners
        searchCurrentRadio.addEventListener('change', setSearchMode);
        searchAllRadio.addEventListener('change', setSearchMode);
    }

    // *** NEW: Set search mode
    function setSearchMode(e) {
        currentSearchMode = e.target.value;
        filterNumbers(); // Re-run search
    }

    // Sanitize input
    function sanitizeInput(input) {
        let sanitized = input.toUpperCase();
        sanitized = sanitized.replace(/\s+/g, '-');
        sanitized = sanitized.replace(/-+/g, '-');
        sanitized = sanitized.replace(/[,.+]/g, '');
        return sanitized;
    }

    // Add a number
    function addNumber() {
        const number = sanitizeInput(numberInput.value.trim());
        if (!number) {
            alert('Please enter a valid number');
            return;
        }
        
        const dateRef = database.ref(`numberListData/${currentDate}/${currentShift}`);
        
        dateRef.once('value', (snapshot) => {
            const numbers = snapshot.val() || [];
            if (numbers.includes(number)) {
                alert('Number already exists in this shift');
                return;
            }
            numbers.push(number);
            dateRef.set(numbers)
                .then(() => {
                    numberInput.value = '';
                })
                .catch((error) => {
                    alert('Error adding number. Please try again.');
                });
        });
    }

    // Load data from Firebase
    function loadDataFromFirebase() {
        numbersList.innerHTML = `<li class="loading flex flex-col items-center justify-center p-10">...</li>`;
        
        const ref = database.ref('numberListData');
        ref.on('value', (snapshot) => {
            currentData = snapshot.val() || {};
            isFirebaseConnected = true;
            updateConnectionStatus('connected');
            loadDataForCurrentSelection();
        }, (error) => {
            isFirebaseConnected = false;
            updateConnectionStatus('failed');
            numbersList.innerHTML = `<li class="no-numbers flex flex-col items-center justify-center p-10">...</li>`;
        });
    }

    // Load data for current selection
    function loadDataForCurrentSelection() {
        filterNumbers(); 
    }

    // *** UPDATED: Render the numbers list based on mode
    function renderNumbersList(items, mode = 'current') {
        numbersList.innerHTML = '';
        
        if (items.length === 0) {
            let message = 'No numbers found for this date and shift.';
            if (mode === 'all') {
                message = searchInput.value ? 'No matches found in all history.' : 'Enter a term to search all history.';
            }
            numbersList.innerHTML = `<li class="no-numbers flex flex-col items-center justify-center p-10">
                                         <i class="bi bi-emoji-frown-fill text-4xl mb-4 text-gray-400"></i>
                                         <span>${message}</span>
                                     </li>`;
            return;
        }
        
        items.forEach((item) => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-3 border border-gray-200 rounded-lg shadow-sm';
            
            const numberDiv = document.createElement('div');
            // Changed to flex-col to stack number and context
            numberDiv.className = 'flex flex-col flex-1 min-w-0'; 
            
            const mainInfoDiv = document.createElement('div');
            mainInfoDiv.className = 'flex items-center gap-3';
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'text-indigo-500';
            iconSpan.innerHTML = '<i class="bi bi-record-circle-fill"></i>';
            mainInfoDiv.appendChild(iconSpan);

            const numberSpan = document.createElement('span');
            numberSpan.className = 'font-semibold text-gray-800 truncate';
            mainInfoDiv.appendChild(numberSpan);
            numberDiv.appendChild(mainInfoDiv);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex gap-1';

            if (mode === 'current') {
                const number = item; // In 'current' mode, item is a string
                numberSpan.textContent = number;
                
                // Add Edit/Delete buttons
                const editBtn = document.createElement('button');
                editBtn.className = 'text-blue-500 hover:bg-blue-100 p-2 rounded-full transition-colors';
                editBtn.innerHTML = '<i class="bi bi-pencil-fill"></i>';
                editBtn.title = 'Edit';
                editBtn.onclick = () => startEditing(li, number); // *** BUGFIX: Pass li and number
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:bg-red-100 p-2 rounded-full transition-colors';
                deleteBtn.innerHTML = '<i class="bi bi-trash-fill"></i>';
                deleteBtn.title = 'Delete';
                deleteBtn.onclick = () => deleteNumber(number); // *** BUGFIX: Pass number
                
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                
                li.appendChild(numberDiv);
                li.appendChild(actionsDiv);
                
            } else { // mode === 'all'
                const { number, date, shift } = item; // In 'all' mode, item is an object
                numberSpan.textContent = number;

                // Add context info
                const contextSpan = document.createElement('span');
                contextSpan.className = 'text-sm text-gray-500 ml-8 capitalize'; // Aligned with number
                contextSpan.textContent = `${shift} shift on ${date}`;
                numberDiv.appendChild(contextSpan);
                
                // No edit/delete buttons for 'all' search
                li.appendChild(numberDiv);
            }
            
            numbersList.appendChild(li);
        });
    }

    // *** UPDATED: Start editing (Bugfix)
    function startEditing(li, originalNumber) { // Pass li element and original number string
        if (!li) return;
        
        const numberDiv = li.querySelector('div:first-child');
        const actionsDiv = li.querySelector('div:last-child');
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'border border-gray-300 rounded-lg px-3 py-1 flex-1 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500';
        input.value = originalNumber;
        
        input.addEventListener('input', function() { this.value = sanitizeInput(this.value); });
        
        // Clear the original content (icon, number)
        numberDiv.innerHTML = ''; 
        numberDiv.appendChild(input);
        
        actionsDiv.innerHTML = '';
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'text-green-500 hover:bg-green-100 p-2 rounded-full';
        saveBtn.innerHTML = '<i class="bi bi-check-lg"></i>';
        saveBtn.title = 'Save';
        saveBtn.onclick = () => saveEdit(originalNumber, input.value); // Pass original number
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'text-red-500 hover:bg-red-100 p-2 rounded-full';
        cancelBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
        cancelBtn.title = 'Cancel';
        cancelBtn.onclick = () => cancelEdit(originalNumber); // Pass original number
        
        actionsDiv.appendChild(saveBtn);
        actionsDiv.appendChild(cancelBtn);
        
        input.focus(); 
    }

    // *** UPDATED: Save edited number (Bugfix)
    function saveEdit(originalNumber, newValue) {
        if (!newValue) {
            alert('Number cannot be empty');
            return;
        }
        newValue = sanitizeInput(newValue);
        
        const dateRef = database.ref(`numberListData/${currentDate}/${currentShift}`);
        
        dateRef.once('value', (snapshot) => {
            const allNumbers = snapshot.val() || [];
            
            // Check for duplicates (excluding self)
            if (allNumbers.includes(newValue) && newValue !== originalNumber) {
                alert('Number already exists in this shift');
                cancelEdit(originalNumber);
                return;
            }
            
            const originalIndex = allNumbers.indexOf(originalNumber);

            if (originalIndex > -1) {
                allNumbers[originalIndex] = newValue;
                dateRef.set(allNumbers)
                    .then(() => console.log('Number updated'))
                    .catch(err => alert('Error updating number.'));
            } else {
                alert('Error updating: Could not find original number.');
            }
        });
    }

    // *** UPDATED: Cancel editing (Bugfix)
    function cancelEdit(originalNumber) {
        loadDataForCurrentSelection(); // Just re-renders, which is correct
    }

    // *** UPDATED: Delete a number (Bugfix)
    function deleteNumber(numberToDelete) {
        if (confirm(`Are you sure you want to delete "${numberToDelete}"?`)) {
            const dateRef = database.ref(`numberListData/${currentDate}/${currentShift}`);
            
            dateRef.once('value', (snapshot) => {
                const allNumbers = snapshot.val() || [];
                const originalIndex = allNumbers.indexOf(numberToDelete);
                
                if (originalIndex > -1) {
                    allNumbers.splice(originalIndex, 1);
                    dateRef.set(allNumbers)
                        .then(() => console.log('Number deleted'))
                        .catch(err => alert('Error deleting number.'));
                } else {
                    alert('Error deleting number. Could not find item.');
                }
            });
        }
    }
    
    // This helper is no longer needed for bugfixes, but filterNumbers uses the logic.
    // function getFilteredNumbers() { ... }

    // *** UPDATED: Filter numbers based on search mode
    function filterNumbers() {
        const searchTerm = searchInput.value.toLowerCase();
        
        if (currentSearchMode === 'current') {
            listTitle.textContent = `List for: ${currentDate} (${currentShift})`;
            const numbers = (currentData[currentDate] && currentData[currentDate][currentShift]) || [];
            
            const filteredNumbers = numbers.filter(num => 
                num.toLowerCase().includes(searchTerm)
            );
            renderNumbersList(filteredNumbers, 'current');
            
        } else { // currentSearchMode === 'all'
            listTitle.textContent = 'All History Results';
            
            if (!searchTerm) {
                // If search term is empty, show empty state for 'all' search
                renderNumbersList([], 'all'); 
                return;
            }

            let allResults = [];
            for (const date in currentData) {
                for (const shift in currentData[date]) {
                    const numbers = currentData[date][shift] || [];
                    numbers.forEach(number => {
                        if (number.toLowerCase().includes(searchTerm)) {
                            allResults.push({
                                number: number,
                                date: date,
                                shift: shift
                            });
                        }
                    });
                }
            }
            // Sort results by date (most recent first)
            allResults.sort((a, b) => b.date.localeCompare(a.date));
            renderNumbersList(allResults, 'all');
        }
    }

    // Initialize the app
    initApp();
    </script>
</body>
</html>
